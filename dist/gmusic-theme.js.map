{"version":3,"sources":["../src/gmusic-theme.js"],"names":["fs","require","COMMON_CSS","readFileSync","__dirname","HIGHLIGHT_CSS","FULL_CSS","BASE_SVG","CONSTANTS","DEFAULTS","BACK_PRIMARY","BACK_SECONDARY","BACK_HIGHLIGHT","FORE_PRIMARY","FORE_SECONDARY","GMusicTheme","options","enabled","type","TYPES","FULL","styleElement","document","createElement","body","appendChild","_injectBackgroundOverlay","window","addEventListener","_injectTimer","updateTheme","_refreshStyleSheet","_drawLogo","documentElement","classList","add","CLASS_NAMESPACE","remove","redrawTheme","colorObject","undefined","validTypesStr","JSON","stringify","Object","keys","Error","backPrimary","backSecondary","backHighlight","forePrimary","foreSecondary","logo","querySelectorAll","normalSVG","customSVG","replace","parent","tmpSVG","parentNode","logoObserver","disconnect","nodeName","id","getAttribute","removeChild","DOMParser","parseFromString","firstChild","setAttribute","MutationObserver","observe","childList","attributes","subtree","setTimeout","wait","clearTimeout","querySelector","container","overlay","styles","HIGHLIGHT_ONLY","innerHTML","substituteColors","colorCode","opacity","clearer","rgbString","percentage","darken","rgb","r","g","b","styleString","s","n","colorString","_darken","parseFloat","_rgba","_inverse","module","exports"],"mappings":";;;;AAAA;;;;;;;;AAEA,IAAMA,KAAKC,QAAQ,IAAR,CAAX;;AAEA;AACA,IAAMC,aAAaF,GAAGG,YAAH,CAAmBC,SAAnB,2BAAoD,MAApD,CAAnB;AACA,IAAMC,gBAAgBL,GAAGG,YAAH,CAAmBC,SAAnB,8BAAuD,MAAvD,CAAtB;AACA,IAAME,WAAWN,GAAGG,YAAH,CAAmBC,SAAnB,yBAAkD,MAAlD,CAAjB;AACA,IAAMG,WAAWP,GAAGG,YAAH,CAAmBC,SAAnB,uBAAgD,MAAhD,CAAjB;AACA,IAAMI,YAAYP,QAAQ,mBAAR,CAAlB;;AAEA,IAAMQ,WAAW;AACfC,gBAAc,SADC;AAEfC,kBAAgB,SAFD;AAGfC,kBAAgB,SAHD,EAGY;AAC3BC,gBAAc,SAJC;AAKfC,kBAAgB;AALD,CAAjB;;IAQMC,W;;AAMJ;;;;;;;AAOA,yBAA0B;AAAA;;AAAA,QAAdC,OAAc,uEAAJ,EAAI;;AAAA;;AACxB;AACA,SAAKN,YAAL,GAAoBD,SAASC,YAA7B;AACA,SAAKC,cAAL,GAAsBF,SAASE,cAA/B;AACA,SAAKC,cAAL,GAAsBH,SAASG,cAA/B;AACA,SAAKC,YAAL,GAAoBJ,SAASI,YAA7B;AACA,SAAKC,cAAL,GAAsBL,SAASK,cAA/B;AACA,SAAKG,OAAL,GAAeD,QAAQC,OAAR,IAAmB,KAAlC;AACA,SAAKC,IAAL,GAAYH,YAAYI,KAAZ,CAAkBC,IAA9B;;AAEA;AACA,SAAKC,YAAL,GAAoBC,SAASC,aAAT,CAAuB,OAAvB,CAApB;AACAD,aAASE,IAAT,CAAcC,WAAd,CAA0B,KAAKJ,YAA/B;;AAEA,SAAKK,wBAAL,CAA8B,IAA9B;AACAC,WAAOC,gBAAP,CAAwB,YAAxB,EAAsC,YAAM;AAC1C,UAAI,MAAKC,YAAT,EAAuB;AACvB,YAAKH,wBAAL;AACD,KAHD;;AAKA;AACA,SAAKI,WAAL,CAAiBd,OAAjB;AACD;;AAED;;;;;;;kCAGc;AACZ,WAAKe,kBAAL;AACA,WAAKC,SAAL;;AAEA;AACA,UAAI,KAAKf,OAAT,EAAkB;AAChBK,iBAASW,eAAT,CAAyBC,SAAzB,CAAmCC,GAAnC,CAAuC3B,UAAU4B,eAAjD;AACD,OAFD,MAEO;AACLd,iBAASW,eAAT,CAAyBC,SAAzB,CAAmCG,MAAnC,CAA0C7B,UAAU4B,eAApD;AACD;AACF;;AAED;;;;;;6BAGS;AACP,WAAKnB,OAAL,GAAe,IAAf;AACA,WAAKqB,WAAL;AACD;;AAED;;;;;;8BAGU;AACR,WAAKrB,OAAL,GAAe,KAAf;AACA,WAAKqB,WAAL;AACD;;AAED;;;;;;;;;;gCAOYC,W,EAAa;AACvB;AACA,UAAIA,YAAYrB,IAAZ,KAAqBsB,SAArB,IAAkCzB,YAAYI,KAAZ,CAAkBoB,YAAYrB,IAA9B,MAAwCsB,SAA9E,EAAyF;AACvF,YAAMC,gBAAgBC,KAAKC,SAAL,CAAeC,OAAOC,IAAP,CAAY9B,YAAYI,KAAxB,CAAf,CAAtB;AACA,cAAM,IAAI2B,KAAJ,yDAAoEL,aAApE,8BACUF,YAAYrB,IADtB,OAAN;AAED;AACD,WAAKR,YAAL,GAAoB6B,YAAYQ,WAAZ,IAA2B,KAAKrC,YAApD;AACA,WAAKC,cAAL,GAAsB4B,YAAYS,aAAZ,IAA6B,KAAKrC,cAAxD;AACA,WAAKC,cAAL,GAAsB2B,YAAYU,aAAZ,IAA6B,KAAKrC,cAAxD;AACA,WAAKC,YAAL,GAAoB0B,YAAYW,WAAZ,IAA2B,KAAKrC,YAApD;AACA,WAAKC,cAAL,GAAsByB,YAAYY,aAAZ,IAA6B,KAAKrC,cAAxD;AACA,WAAKI,IAAL,GAAYqB,YAAYrB,IAAZ,IAAoB,KAAKA,IAArC;AACA,WAAKoB,WAAL;AACD;;;gCAEW;AAAA;;AACV,UAAMc,OAAO9B,SAAS+B,gBAAT,CAA0B,YAA1B,EAAwC,CAAxC,CAAb;AACA,UAAMC,YAAY/C,QAAlB;AACA,UAAMgD,YAAYD,UAAUE,OAAV,CAAkB,SAAlB,EAA6B,KAAK1C,cAAlC,EAAkD0C,OAAlD,CAA0D,oBAA1D,EAAgF,oBAAhF,CAAlB;AACA,UAAIC,eAAJ;AACA,UAAIC,eAAJ;;AAEA,UAAIN,IAAJ,EAAU;AACRK,iBAASL,KAAKO,UAAd;AACA,YAAI,KAAKC,YAAT,EAAuB;AACrB,eAAKA,YAAL,CAAkBC,UAAlB;AACA,iBAAO,KAAKD,YAAZ;AACD;;AAED,YAAI,KAAK3C,OAAT,EAAkB;AAChB;AACA,cAAImC,KAAKU,QAAL,KAAkB,KAAlB,IAA2BV,KAAKW,EAAL,KAAY,eAAvC,IAA0DX,KAAKY,YAAL,CAAkB,gBAAlB,MAAwC,KAAKlD,cAA3G,EAA2H;AACzH2C,mBAAOQ,WAAP,CAAmBb,IAAnB;AACAM,qBAAU,IAAIQ,SAAJ,EAAD,CAAkBC,eAAlB,CAAkCZ,SAAlC,EAA6C,UAA7C,EAAyDa,UAAlE;AACAV,mBAAOW,YAAP,CAAoB,gBAApB,EAAsC,KAAKvD,cAA3C;AACA2C,mBAAOhC,WAAP,CAAmBiC,MAAnB;AACD;AACF,SARD,MAQO,IAAIN,KAAKU,QAAL,KAAkB,KAAlB,IAA2BV,KAAKW,EAAL,KAAY,eAA3C,EAA4D;AACjE;AACAN,iBAAOQ,WAAP,CAAmBb,IAAnB;AACAK,iBAAOhC,WAAP,CAAoB,IAAIyC,SAAJ,EAAD,CAAkBC,eAAlB,CAAkCb,SAAlC,EAA6C,UAA7C,EAAyDc,UAA5E;AACD;;AAED;AACA,aAAKR,YAAL,GAAoB,IAAIU,gBAAJ,CAAqB,YAAM;AAC7C,iBAAKtC,SAAL;AACD,SAFmB,CAApB;AAGA,aAAK4B,YAAL,CAAkBW,OAAlB,CAA0Bd,MAA1B,EAAkC;AAChCe,qBAAW,IADqB;AAEhCC,sBAAY,IAFoB;AAGhCC,mBAAS;AAHuB,SAAlC;AAKD,OA9BD,MA8BO;AACL;AACAC,mBAAW,KAAK3C,SAAhB,EAA2B,EAA3B;AACD;AACF;;;+CAEsC;AAAA;;AAAA,UAAd4C,IAAc,uEAAP,KAAO;;AACrC,WAAK/C,YAAL,GAAoBgD,aAAa,KAAKhD,YAAlB,CAApB;AACA,UAAIP,SAASwD,aAAT,CAAuB,eAAvB,CAAJ,EAA6C;AAC7C,UAAMC,YAAYzD,SAASwD,aAAT,CAAuB,sBAAvB,CAAlB;AACA,UAAI,CAACC,SAAL,EAAgB;AACd,YAAIH,IAAJ,EAAU,KAAK/C,YAAL,GAAoB8C,WAAW;AAAA,iBAAM,OAAKjD,wBAAL,CAA8BkD,IAA9B,CAAN;AAAA,SAAX,EAAsD,EAAtD,CAApB;AACV;AACD;AACD,UAAMI,UAAU1D,SAASC,aAAT,CAAuB,KAAvB,CAAhB;AACAyD,cAAQjB,EAAR,GAAa,cAAb;AACAgB,gBAAUtD,WAAV,CAAsBuD,OAAtB;AACD;;;yCAEoB;AACnB;AACA,UAAIC,SAAS/E,UAAb;AACA,cAAQ,KAAKgB,IAAb;AACE,aAAKH,YAAYI,KAAZ,CAAkBC,IAAvB;AACE6D,oBAAU3E,QAAV;AACA;AACF,aAAKS,YAAYI,KAAZ,CAAkB+D,cAAvB;AACED,oBAAU5E,aAAV;AACA;AACF;AACE;AARJ;AAUA,WAAKgB,YAAL,CAAkB8D,SAAlB,GAA8B,KAAKC,gBAAL,CAAsBH,MAAtB,CAA9B;AACD;;;0BAEKI,S,EAAWC,O,EAAS;AACxB,aAAO,qBAAMD,SAAN,EAAiBE,OAAjB,CAAyBD,OAAzB,EAAkCE,SAAlC,EAAP;AACD;;;4BAEOH,S,EAAWI,U,EAAY;AAC7B,aAAO,qBAAMJ,SAAN,EAAiBK,MAAjB,CAAwBD,UAAxB,EAAoCD,SAApC,EAAP;AACD;;;6BAEQH,S,EAAW;AAClB,UAAMM,MAAM,qBAAMN,SAAN,EAAiBM,GAAjB,EAAZ;AACA,aAAO,qBAAM;AACXC,WAAG,MAAMD,IAAIC,CADF;AAEXC,WAAG,MAAMF,IAAIE,CAFF;AAGXC,WAAG,MAAMH,IAAIG;AAHF,OAAN,EAIJN,SAJI,EAAP;AAKD;;;qCAEgBO,W,EAAa;AAAA;;AAC5B,aAAOA,YACJvC,OADI,CACI,mBADJ,EACyB,KAAK9C,YAD9B,EAEJ8C,OAFI,CAEI,qBAFJ,EAE2B,KAAK7C,cAFhC,EAGJ6C,OAHI,CAGI,qBAHJ,EAG2B,KAAK5C,cAHhC,EAIJ4C,OAJI,CAII,mBAJJ,EAIyB,KAAK3C,YAJ9B,EAKJ2C,OALI,CAKI,qBALJ,EAK2B,KAAK1C,cALhC,EAMJ0C,OANI,CAMI,8CANJ,EAMoD,UAACwC,CAAD,EAAIC,CAAJ,EAAOC,WAAP;AAAA,eAAuB,OAAKC,OAAL,CAAaD,WAAb,EAA0BE,WAAWH,CAAX,CAA1B,CAAvB;AAAA,OANpD,EAOJzC,OAPI,CAOI,4CAPJ,EAOkD,UAACwC,CAAD,EAAIC,CAAJ,EAAOC,WAAP;AAAA,eAAuB,OAAKG,KAAL,CAAWH,WAAX,EAAwBE,WAAWH,CAAX,CAAxB,CAAvB;AAAA,OAPlD,EAQJzC,OARI,CAQI,gCARJ,EAQsC,UAACwC,CAAD,EAAIE,WAAJ;AAAA,eAAoB,OAAKI,QAAL,CAAcJ,WAAd,CAApB;AAAA,OARtC,EASJ1C,OATI,CASI,8BATJ,EASoC,EATpC,CAAP;AAUD;;;;;;AA/LGzC,W,CACGI,K,GAAQ;AACbC,QAAM,MADO;AAEb8D,kBAAgB;AAFH,C;;;AAiMjBqB,OAAOC,OAAP,GAAiBzF,WAAjB","file":"gmusic-theme.js","sourcesContent":["import color from 'color';\n\nconst fs = require('fs');\n\n// DEV: These constants will be transformed into string constants by browserify\nconst COMMON_CSS = fs.readFileSync(`${__dirname}/../build/common.css`, 'utf8');\nconst HIGHLIGHT_CSS = fs.readFileSync(`${__dirname}/../build/highlight.css`, 'utf8');\nconst FULL_CSS = fs.readFileSync(`${__dirname}/../build/full.css`, 'utf8');\nconst BASE_SVG = fs.readFileSync(`${__dirname}/../lib/logo.svg`, 'utf8');\nconst CONSTANTS = require('../lib/_constants');\n\nconst DEFAULTS = {\n  BACK_PRIMARY: '#222326',\n  BACK_SECONDARY: '#121314',\n  BACK_HIGHLIGHT: '#615F59', // #1a1b1d\n  FORE_PRIMARY: '#FFFFFF',\n  FORE_SECONDARY: '#FF5722',\n};\n\nclass GMusicTheme {\n  static TYPES = {\n    FULL: 'FULL',\n    HIGHLIGHT_ONLY: 'HIGHLIGHT_ONLY',\n  };\n\n  /**\n   * Constructor for a new Google Music Theme API.\n   *\n   * @param  {Object} - A colors object containing `backPrimary`, `backSecondary`,\n   *                    `backHighlight`, `forePrimary`, `foreSecondary` attributes\n   *                    any attribute not included will not be overriden\n   */\n  constructor(options = {}) {\n    // DEV: Use the colors specified in the options or the default if it isn't set\n    this.BACK_PRIMARY = DEFAULTS.BACK_PRIMARY;\n    this.BACK_SECONDARY = DEFAULTS.BACK_SECONDARY;\n    this.BACK_HIGHLIGHT = DEFAULTS.BACK_HIGHLIGHT;\n    this.FORE_PRIMARY = DEFAULTS.FORE_PRIMARY;\n    this.FORE_SECONDARY = DEFAULTS.FORE_SECONDARY;\n    this.enabled = options.enabled || false;\n    this.type = GMusicTheme.TYPES.FULL;\n\n    // DEV: This is the style element where we put our custom CSS\n    this.styleElement = document.createElement('style');\n    document.body.appendChild(this.styleElement);\n\n    this._injectBackgroundOverlay(true);\n    window.addEventListener('hashchange', () => {\n      if (this._injectTimer) return;\n      this._injectBackgroundOverlay();\n    });\n\n    // DEV: updateTheme calls redrawTheme\n    this.updateTheme(options);\n  }\n\n  /**\n   * Regenerates the custom CSS and and updates the SVG logo\n   */\n  redrawTheme() {\n    this._refreshStyleSheet();\n    this._drawLogo();\n\n    // DEV: Add / Remove appropriate classes\n    if (this.enabled) {\n      document.documentElement.classList.add(CONSTANTS.CLASS_NAMESPACE);\n    } else {\n      document.documentElement.classList.remove(CONSTANTS.CLASS_NAMESPACE);\n    }\n  }\n\n  /**\n  * Enabled the custom theme\n  */\n  enable() {\n    this.enabled = true;\n    this.redrawTheme();\n  }\n\n  /**\n   * Disables the custom theme\n   */\n  disable() {\n    this.enabled = false;\n    this.redrawTheme();\n  }\n\n  /**\n   * Updates the custom colors used in the theme and redraws the custom CSS\n   *\n   * @param  {Object} - A colors object containing `backPrimary`, `backSecondary`,\n   *                    `backHighlight`, `forePrimary`, `foreSecondary` attributes\n   *                    any attribute not included will not be overriden\n   */\n  updateTheme(colorObject) {\n    // DEV: Validate the updateTheme type\n    if (colorObject.type !== undefined && GMusicTheme.TYPES[colorObject.type] === undefined) {\n      const validTypesStr = JSON.stringify(Object.keys(GMusicTheme.TYPES));\n      throw new Error(`\\`updateTheme\\` expected \\`colorObject.type\\` to be in ${validTypesStr}\n        but it was \"${colorObject.type}\"`);\n    }\n    this.BACK_PRIMARY = colorObject.backPrimary || this.BACK_PRIMARY;\n    this.BACK_SECONDARY = colorObject.backSecondary || this.BACK_SECONDARY;\n    this.BACK_HIGHLIGHT = colorObject.backHighlight || this.BACK_HIGHLIGHT;\n    this.FORE_PRIMARY = colorObject.forePrimary || this.FORE_PRIMARY;\n    this.FORE_SECONDARY = colorObject.foreSecondary || this.FORE_SECONDARY;\n    this.type = colorObject.type || this.type;\n    this.redrawTheme();\n  }\n\n  _drawLogo() {\n    const logo = document.querySelectorAll('.menu-logo')[0];\n    const normalSVG = BASE_SVG;\n    const customSVG = normalSVG.replace('#EE6B00', this.FORE_SECONDARY).replace('id=\"normalSVGIcon\"', 'id=\"customSVGIcon\"');\n    let parent;\n    let tmpSVG;\n\n    if (logo) {\n      parent = logo.parentNode;\n      if (this.logoObserver) {\n        this.logoObserver.disconnect();\n        delete this.logoObserver;\n      }\n\n      if (this.enabled) {\n        // DEV: Only update the SVG element if we need to\n        if (logo.nodeName === 'IMG' || logo.id === 'normalSVGIcon' || logo.getAttribute('current-custom') !== this.FORE_SECONDARY) {\n          parent.removeChild(logo);\n          tmpSVG = (new DOMParser()).parseFromString(customSVG, 'text/xml').firstChild;\n          tmpSVG.setAttribute('current-custom', this.FORE_SECONDARY);\n          parent.appendChild(tmpSVG);\n        }\n      } else if (logo.nodeName === 'IMG' || logo.id === 'customSVGIcon') {\n        // DEV: Only update the SVG element if we need to\n        parent.removeChild(logo);\n        parent.appendChild((new DOMParser()).parseFromString(normalSVG, 'text/xml').firstChild);\n      }\n\n      // DEV: Google sometimes changes its logo by itself, we need to monitor this\n      this.logoObserver = new MutationObserver(() => {\n        this._drawLogo();\n      });\n      this.logoObserver.observe(parent, {\n        childList: true,\n        attributes: true,\n        subtree: true,\n      });\n    } else {\n      // DEV: If the logo isn't ready yet wait a few milliseconds and try again\n      setTimeout(this._drawLogo, 10);\n    }\n  }\n\n  _injectBackgroundOverlay(wait = false) {\n    this._injectTimer = clearTimeout(this._injectTimer);\n    if (document.querySelector('#themeOverlay')) return;\n    const container = document.querySelector('#backgroundContainer');\n    if (!container) {\n      if (wait) this._injectTimer = setTimeout(() => this._injectBackgroundOverlay(wait), 50);\n      return;\n    }\n    const overlay = document.createElement('div');\n    overlay.id = 'themeOverlay';\n    container.appendChild(overlay);\n  }\n\n  _refreshStyleSheet() {\n    // DEV: Take the current style string and put it in the style element in the DOM)\n    let styles = COMMON_CSS;\n    switch (this.type) {\n      case GMusicTheme.TYPES.FULL:\n        styles += FULL_CSS;\n        break;\n      case GMusicTheme.TYPES.HIGHLIGHT_ONLY:\n        styles += HIGHLIGHT_CSS;\n        break;\n      default:\n        break;\n    }\n    this.styleElement.innerHTML = this.substituteColors(styles);\n  }\n\n  _rgba(colorCode, opacity) {\n    return color(colorCode).clearer(opacity).rgbString();\n  }\n\n  _darken(colorCode, percentage) {\n    return color(colorCode).darken(percentage).rgbString();\n  }\n\n  _inverse(colorCode) {\n    const rgb = color(colorCode).rgb();\n    return color({\n      r: 255 - rgb.r,\n      g: 255 - rgb.g,\n      b: 255 - rgb.b,\n    }).rgbString();\n  }\n\n  substituteColors(styleString) {\n    return styleString\n      .replace(/<<BACK_PRIMARY>>/g, this.BACK_PRIMARY)\n      .replace(/<<BACK_SECONDARY>>/g, this.BACK_SECONDARY)\n      .replace(/<<BACK_HIGHLIGHT>>/g, this.BACK_HIGHLIGHT)\n      .replace(/<<FORE_PRIMARY>>/g, this.FORE_PRIMARY)\n      .replace(/<<FORE_SECONDARY>>/g, this.FORE_SECONDARY)\n      .replace(/<<DARKEN ([01]+.?[0-9]*)>>(.+?)<<\\/DARKEN>>/g, (s, n, colorString) => this._darken(colorString, parseFloat(n)))\n      .replace(/<<ALPHA ([01]+.?[0-9]*)>>(.+?)<<\\/ALPHA>>/g, (s, n, colorString) => this._rgba(colorString, parseFloat(n)))\n      .replace(/<<INVERSE>>(.+?)<<\\/INVERSE>>/g, (s, colorString) => this._inverse(colorString))\n      .replace(/<<NOTIMPORTANT>> !important/g, '');\n  }\n}\n\nmodule.exports = GMusicTheme;\n"]}